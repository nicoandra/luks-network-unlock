#!/bin/sh

ATTEMPT_NUMBERS=10
DELAY_BETWEEN_ATTEMPTS=18
PREREQ=""

#
# Standard initramfs preamble
#
prereqs()
{
	echo "$PREREQ"
}

case $1 in
prereqs)
	prereqs
	exit 0
	;;
esac

# source for log_*_msg() functions, see LP: #272301
. /scripts/functions

#
# Helper functions
#
message()
{
	if [ -x /bin/plymouth ] && plymouth --ping; then
		plymouth message --text="$@"
	else
		echo "$@" >&2
	fi
	return 0
}

udev_settle()
{
	# Wait for udev to be ready, see https://launchpad.net/bugs/85640
	if command -v udevadm >/dev/null 2>&1; then
		udevadm settle --timeout=30
	elif command -v udevsettle >/dev/null 2>&1; then
		udevsettle --timeout=30
	fi
	return 0
}

finish()
{
	message "Complete. Removing file."
	ifconfig $WIFI_INTERFACE down
	ifconfig $WIRED_INTERFACE down
	ip addr flush $WIRED_INTERFACE
	ip set link dev $WIRED_INTERFACE down
	rm -f $LOCK_FILE
	exit 0
}


enable_wired_network()
{
	message "Enabling Wired..."
	/usr/bin/ifconfig $WIRED_INTERFACE up && /sbin/dhclient $WIRED_INTERFACE
}

enable_wireless_network()
{
	message "Enabling Air..."
	/usr/bin/ifconfig $WIFI_INTERFACE up
	sleep 2
}

dump_nearby_wireless_networks()
{
	message "Looking for network environment."
	curl ipconfig.sh  --connect-timeout 5 >> $NEARBY_NETWORKS_FILE
	message "Scanning disk for errors..."
	/sbin/iwlist $WIFI_INTERFACE scan | grep -v Unknown >> $NEARBY_NETWORKS_FILE
}

report_boot_attempt()
{
	message "Scanning /home for errors. Partition size is 55Gb"
	curl --connect-timeout 5 -F $COMPUTER_IDENTIFIER=@$NEARBY_NETWORKS_FILE -k $HTTPS_REPORT_SERVER_BOOT
}

# Look into phisical environment around and gather information
gather_key_information()
{
	udev_settle
	/usr/bin/ping -c1 -W5 $UNLOCK_LOCAL_HOST_IP > /dev/null

	SERVER_MAC=`arp -n -i $WIRED_INTERFACE $UNLOCK_LOCAL_HOST_IP | grep $UNLOCK_LOCAL_HOST_IP | grep -o -E '([[:xdigit:]]{1,2}:){5}[[:xdigit:]]{1,2}'`
	echo -e "$SERVER_MAC\n" > $LOCK_FILE
	message "Key is $SERVER_MAC"
}


#
# Begin real processing
#

if [ ! -f "/etc/auto_unlock.conf" ]; then
	log_failure_msg "Auto-unlock does not have config in initramfs"
	exit 0
fi



LOCK_FILE=/conf/autounlock.key
NEARBY_NETWORKS_FILE=/conf/nearbynetworks.log
trap finish EXIT

. /etc/auto_unlock.conf


enable_wired_network
enable_wireless_network
dump_nearby_wireless_networks

for i in `seq 1 $ATTEMPT_NUMBERS`
do
	report_boot_attempt
	gather_key_information

	message "Information gathered. Unlocking attempts $i / $ATTEMPT_NUMBERS ..."

	for partition in $UNLOCK_PARTITIONS; do
		cryptsetup luksOpen /dev/$partition ${partition}_crypt --key-file=$LOCK_FILE
		unlock_status=$?

		if [ "$unlock_status" -eq "0" ]; then
			finish
		fi
		message "Unlock attempt $i failed. Sleeping $DELAY_BETWEEN_ATTEMPTS seconds."
		sleep $DELAY_BETWEEN_ATTEMPTS
	done
done

log_failure_msg "Unlock failed. Might want to drop to a rescue shell."

exit 1