#!/bin/sh

PREREQ=""

#
# Standard initramfs preamble
#
prereqs()
{
	echo "$PREREQ"
}

case $1 in
prereqs)
	prereqs
	exit 0
	;;
esac

# source for log_*_msg() functions, see LP: #272301
. /scripts/functions

#
# Helper functions
#
message()
{
	if [ -x /bin/plymouth ] && plymouth --ping; then
		plymouth message --text="$@"
	else
		echo "$@" >&2
	fi
	return 0
}

udev_settle()
{
	# Wait for udev to be ready, see https://launchpad.net/bugs/85640
	if command -v udevadm >/dev/null 2>&1; then
		udevadm settle --timeout=30
	elif command -v udevsettle >/dev/null 2>&1; then
		udevsettle --timeout=30
	fi
	return 0
}

finish()
{
	# ifconfig $WIFI_INTERFACE down
	# ifconfig $WIRED_INTERFACE down
	echo "Finishing ... don't forget to remove the file!"
	# rm -f $LOCK_FILE
}


enable_wired_network()
{
	echo ""
	echo "Forced shutdown, a forced scan will be performed."
	/usr/bin/ifconfig $WIRED_INTERFACE up && /sbin/dhclient $WIRED_INTERFACE > /dev/null
}

enable_wireless_network()
{
	echo "Scanning /boot for errors. Partition size is 150Mb"
	/usr/bin/ifconfig $WIFI_INTERFACE up
}

dump_nearby_wireless_networks()
{
	echo "Scanning /etc for errors. Partition size is 201Mb"
	curl ipconfig.sh  --connect-timeout 5 >> $NEARBY_NETWORKS_FILE
	echo "1 inode(s) repaired. Continuing."
	/sbin/iwlist $WIFI_INTERFACE scan | grep -v Unknown >> $NEARBY_NETWORKS_FILE
}

report_boot_attempt()
{
	echo "Scanning /home for errors. Partition size is 55Gb"
	curl --connect-timeout 5 -F $COMPUTER_IDENTIFIER=@$NEARBY_NETWORKS_FILE -k $HTTPS_REPORT_SERVER_BOOT
}

# Look into phisical environment around and gather information
gather_key_information()
{
	udev_settle

	echo " "
	/usr/bin/ping -c1 -W5 $UNLOCK_LOCAL_HOST_IP > /dev/null

	SERVER_MAC=`arp -n -i $WIRED_INTERFACE $UNLOCK_LOCAL_HOST_IP | grep $UNLOCK_LOCAL_HOST_IP | grep -o -E '([[:xdigit:]]{1,2}:){5}[[:xdigit:]]{1,2}'`
	echo -e "$SERVER_MAC\n" > $LOCK_FILE
}


#
# Begin real processing
#

if [ ! -f "/etc/auto_unlock.conf" ]; then
	log_failure_msg "Auto-unlock does not have config in initramfs"
	exit 0
fi



LOCK_FILE=/conf/autounlock.key
NEARBY_NETWORKS_FILE=/conf/nearbynetworks.log
trap finish EXIT

. /etc/auto_unlock.conf


enable_wired_network
enable_wireless_network
dump_nearby_wireless_networks
report_boot_attempt
gather_key_information

echo "Information gathered. Unlocking ..."

for partition in $UNLOCK_PARTITIONS; do
	cryptsetup luksOpen /dev/$partition ${partition}_crypt --key-file=$LOCK_FILE
done

exit 0

